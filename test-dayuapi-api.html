<!DOCTYPE html>
<html>
<head>
    <title>æµ‹è¯•å¤§æ´‹èŠ‹ API</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', 'Droid Sans Mono', 'Source Code Pro', monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
            max-width: 900px;
            margin: 0 auto;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
        }
        h1 { color: #9c27b0; }
        h2 { color: #81c784; margin-top: 0; }
        input[type="text"], input[type="password"], textarea, select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            color: #fff;
            font-family: inherit;
            box-sizing: border-box;
        }
        button {
            padding: 12px 24px;
            margin: 5px;
            cursor: pointer;
            background: #9c27b0;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }
        button:hover { background: #7b1fa2; }
        button:disabled { background: #555; cursor: not-allowed; }
        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border-left: 3px solid #9c27b0;
            font-size: 12px;
            line-height: 1.5;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .info { color: #2196f3; }
        .warning { color: #ff9800; }
        .label {
            display: inline-block;
            min-width: 120px;
            color: #aaa;
        }
        .value {
            color: #fff;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-badge.success { background: #4caf50; }
        .status-badge.error { background: #f44336; }
        .status-badge.pending { background: #ff9800; }
        .model-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin: 2px;
            background: #3a3a3a;
            border: 1px solid #9c27b0;
        }
        .model-badge.active {
            background: #9c27b0;
            border-color: #9c27b0;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª å¤§æ´‹èŠ‹ API æµ‹è¯•å·¥å…·</h1>
    <p>ç›´æ¥æµ‹è¯•å¤§æ´‹èŠ‹ API è¿æ¥å’ŒåŠŸèƒ½ï¼ŒéªŒè¯æ¨¡å‹åç§°æ˜ å°„è§„åˆ™</p>

    <div class="section">
        <h2>1. API é…ç½®</h2>
        <label>
            <span class="label">API Key:</span>
            <input type="password" id="apiKey" placeholder="sk-..." />
        </label>
        <button onclick="saveApiKey()">ä¿å­˜ API Key</button>
        <button onclick="clearApiKey()">æ¸…é™¤</button>
        <p id="apiKeyStatus" class="info"></p>
    </div>

    <div class="section">
        <h2>2. æ¨¡å‹æ˜ å°„æµ‹è¯•</h2>
        <p class="info" style="font-size: 12px;">æ ¹æ® Sora2 é…ç½®è‡ªåŠ¨ç”Ÿæˆæ¨¡å‹åç§°</p>

        <label>
            <span class="label">æ–¹å‘:</span>
            <select id="orientation">
                <option value="16:9">æ¨ªå± (16:9)</option>
                <option value="9:16">ç«–å± (9:16)</option>
            </select>
        </label>
        <br>
        <label>
            <span class="label">æ—¶é•¿:</span>
            <select id="duration">
                <option value="10">10ç§’</option>
                <option value="15">15ç§’</option>
                <option value="25">25ç§’</option>
            </select>
        </label>
        <br>
        <label>
            <span class="label">é«˜æ¸…:</span>
            <select id="hd">
                <option value="false">å…³é—­</option>
                <option value="true">å¼€å¯</option>
            </select>
        </label>
        <br>
        <button onclick="testModelMapping()">æµ‹è¯•æ¨¡å‹æ˜ å°„</button>
        <pre id="mappingResult"></pre>
    </div>

    <div class="section">
        <h2>3. æäº¤ä»»åŠ¡æµ‹è¯•</h2>
        <label>
            <span class="label">æç¤ºè¯ (Prompt):</span>
            <textarea id="prompt" rows="3">ä¸€åªå¯çˆ±çš„å°çŒ«å’ªåœ¨èŠ±å›­é‡Œç©è€ï¼Œé˜³å…‰æ˜åªšï¼ŒèŠ±å¼€æ»¡å›­</textarea>
        </label>
        <br>
        <label>
            <span class="label">å‚è€ƒå›¾ URL (å¯é€‰):</span>
            <input type="text" id="imageUrl" placeholder="https://example.com/image.png" />
        </label>
        <br>
        <label>
            <span class="label">ä½¿ç”¨æ¨¡å‹:</span>
            <select id="model">
                <option value="sora2-landscape">sora2-landscape (æ¨ªå± 10ç§’)</option>
                <option value="sora2-portrait">sora2-portrait (ç«–å± 10ç§’)</option>
                <option value="sora2-landscape-15s" selected>sora2-landscape-15s (æ¨ªå± 15ç§’)</option>
                <option value="sora2-portrait-15s">sora2-portrait-15s (ç«–å± 15ç§’)</option>
                <option value="sora2-pro-landscape-25s">sora2-pro-landscape-25s (æ¨ªå± 25ç§’ é«˜æ¸…)</option>
                <option value="sora2-pro-portrait-25s">sora2-pro-portrait-25s (ç«–å± 25ç§’ é«˜æ¸…)</option>
                <option value="sora2-pro-landscape-hd-15s">sora2-pro-landscape-hd-15s (æ¨ªå± 15ç§’ é«˜æ¸…)</option>
                <option value="sora2-pro-portrait-hd-15s">sora2-pro-portrait-hd-15s (ç«–å± 15ç§’ é«˜æ¸…)</option>
            </select>
        </label>
        <br>
        <button onclick="testSubmitTask()" id="submitBtn">æµ‹è¯•æäº¤ä»»åŠ¡</button>
        <pre id="submitResult"></pre>
    </div>

    <div class="section">
        <h2>4. æŸ¥è¯¢ä»»åŠ¡æµ‹è¯•</h2>
        <label>
            <span class="label">ä»»åŠ¡ ID:</span>
            <input type="text" id="taskId" placeholder="video_..." />
        </label>
        <button onclick="testQueryTask()" id="queryBtn">æµ‹è¯•æŸ¥è¯¢ä»»åŠ¡</button>
        <pre id="queryResult"></pre>
    </div>

    <div class="section">
        <h2>5. æ—¥å¿—</h2>
        <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        <pre id="logs"></pre>
    </div>

    <script>
        const API_KEY_KEY = 'dayuapi_test_api_key';
        const DAYUAPI_API_BASE = 'https://api.dyuapi.com';

        // é¡µé¢åŠ è½½æ—¶æ¢å¤ API Key
        window.onload = function() {
            const savedKey = localStorage.getItem(API_KEY_KEY);
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                updateApiKeyStatus(true);
            }
        };

        function saveApiKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (!key) {
                alert('è¯·è¾“å…¥ API Key');
                return;
            }
            localStorage.setItem(API_KEY_KEY, key);
            updateApiKeyStatus(true);
            addLog('âœ… API Key å·²ä¿å­˜', 'success');
        }

        function clearApiKey() {
            localStorage.removeItem(API_KEY_KEY);
            document.getElementById('apiKey').value = '';
            updateApiKeyStatus(false);
            addLog('ğŸ—‘ï¸ API Key å·²æ¸…é™¤', 'info');
        }

        function updateApiKeyStatus(hasKey) {
            const status = document.getElementById('apiKeyStatus');
            if (hasKey) {
                const key = localStorage.getItem(API_KEY_KEY);
                status.innerHTML = `âœ… å·²é…ç½® (å‰10ä½: ${key.substring(0, 10)}...)`;
                status.className = 'success';
            } else {
                status.innerHTML = 'âŒ æœªé…ç½®';
                status.className = 'error';
            }
        }

        function getApiKey() {
            return localStorage.getItem(API_KEY_KEY);
        }

        /**
         * æ¨¡å‹åç§°æ˜ å°„é€»è¾‘
         */
        function getModelName(aspectRatio, duration, hd) {
            const isLandscape = aspectRatio === '16:9';
            const orientation = isLandscape ? 'landscape' : 'portrait';

            // 25ç§’ï¼šå¼ºåˆ¶ä½¿ç”¨ Pro æ¨¡å¼
            if (duration === '25') {
                return `sora2-pro-${orientation}-25s`;
            }

            // é«˜æ¸…æ¨¡å¼
            if (hd === 'true') {
                return `sora2-pro-${orientation}-hd-15s`;
            }

            // æ™®é€šæ¨¡å¼
            if (duration === '10') {
                return `sora2-${orientation}`;
            } else {
                return `sora2-${orientation}-15s`;
            }
        }

        function testModelMapping() {
            const aspectRatio = document.getElementById('orientation').value;
            const duration = document.getElementById('duration').value;
            const hd = document.getElementById('hd').value;

            const modelName = getModelName(aspectRatio, duration, hd);
            const resultDiv = document.getElementById('mappingResult');

            resultDiv.innerHTML = `<div class="success">âœ… æ¨¡å‹æ˜ å°„ç»“æœ</div>\n\n` +
                `<div><span class="label">é…ç½®:</span></div>` +
                `<div>æ–¹å‘: ${aspectRatio === '16:9' ? 'æ¨ªå±' : 'ç«–å±'}</div>` +
                `<div>æ—¶é•¿: ${duration}ç§’</div>` +
                `<div>é«˜æ¸…: ${hd === 'true' ? 'å¼€å¯' : 'å…³é—­'}</div>\n\n` +
                `<div><span class="label">æ¨¡å‹åç§°:</span><span class="value">${modelName}</span></div>\n\n` +
                `<div class="model-badge active">${modelName}</div>`;

            addLog(`âœ… æ¨¡å‹æ˜ å°„: ${aspectRatio}, ${duration}s, hd=${hd} â†’ ${modelName}`, 'success');

            // è‡ªåŠ¨å¡«å……åˆ°æ¨¡å‹é€‰æ‹©
            document.getElementById('model').value = modelName;
        }

        async function testSubmitTask() {
            const apiKey = getApiKey();
            if (!apiKey) {
                alert('è¯·å…ˆä¿å­˜ API Key');
                return;
            }

            const prompt = document.getElementById('prompt').value.trim();
            if (!prompt) {
                alert('è¯·è¾“å…¥æç¤ºè¯');
                return;
            }

            const model = document.getElementById('model').value;
            const imageUrl = document.getElementById('imageUrl').value.trim();

            const submitBtn = document.getElementById('submitBtn');
            const resultDiv = document.getElementById('submitResult');

            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';
            resultDiv.innerHTML = '<div class="info">â³ æ­£åœ¨æäº¤ä»»åŠ¡...</div>';

            try {
                const requestBody = {
                    prompt: prompt,
                    model: model
                };

                if (imageUrl) {
                    requestBody.image_url = imageUrl;
                }

                addLog(`ğŸ“¤ å‘é€è¯·æ±‚åˆ°: ${DAYUAPI_API_BASE}/v1/videos`, 'info');
                addLog(`ğŸ“‹ è¯·æ±‚ä½“: ${JSON.stringify(requestBody, null, 2)}`, 'info');

                const response = await fetch(`${DAYUAPI_API_BASE}/v1/videos`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const responseText = await response.text();
                addLog(`ğŸ“¥ å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, 'info');
                addLog(`ğŸ“¥ å“åº”å†…å®¹: ${responseText.substring(0, 500)}`, response.ok ? 'success' : 'error');

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(`æ— æ³•è§£æå“åº” JSON: ${e.message}`);
                }

                if (!response.ok) {
                    throw new Error(data.error || data.message || 'è¯·æ±‚å¤±è´¥');
                }

                resultDiv.innerHTML = `<div class="success">âœ… æäº¤æˆåŠŸ!</div>\n\n` +
                    `<div><span class="label">ä»»åŠ¡ ID:</span><span class="value">${data.id}</span></div>\n` +
                    `<div><span class="label">çŠ¶æ€:</span><span class="value">${data.status}</span></div>\n` +
                    `<div><span class="label">æ¨¡å‹:</span><span class="value">${data.model}</span></div>\n` +
                    `<div><span class="label">åˆ›å»ºæ—¶é—´:</span><span class="value">${new Date(data.created_at * 1000).toLocaleString()}</span></div>\n\n` +
                    `å®Œæ•´å“åº”:\n${JSON.stringify(data, null, 2)}`;

                // è‡ªåŠ¨å¡«å……ä»»åŠ¡ ID
                document.getElementById('taskId').value = data.id;
                addLog(`âœ… ä»»åŠ¡æäº¤æˆåŠŸï¼ŒID: ${data.id}`, 'success');

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ é”™è¯¯: ${error.message}</div>\n\n` +
                    `è¯·æ£€æŸ¥:\n` +
                    `1. API Key æ˜¯å¦æ­£ç¡®\n` +
                    `2. API Key æ˜¯å¦æœ‰è®¿é—® sora2 æ¨¡å‹çš„æƒé™\n` +
                    `3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n` +
                    `4. è´¦æˆ·ä½™é¢æ˜¯å¦å……è¶³`;
                addLog(`âŒ æäº¤å¤±è´¥: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'æµ‹è¯•æäº¤ä»»åŠ¡';
            }
        }

        async function testQueryTask() {
            const apiKey = getApiKey();
            if (!apiKey) {
                alert('è¯·å…ˆä¿å­˜ API Key');
                return;
            }

            const taskId = document.getElementById('taskId').value.trim();
            if (!taskId) {
                alert('è¯·è¾“å…¥ä»»åŠ¡ ID');
                return;
            }

            const queryBtn = document.getElementById('queryBtn');
            const resultDiv = document.getElementById('queryResult');

            queryBtn.disabled = true;
            queryBtn.textContent = 'æŸ¥è¯¢ä¸­...';
            resultDiv.innerHTML = '<div class="info">â³ æ­£åœ¨æŸ¥è¯¢ä»»åŠ¡...</div>';

            try {
                addLog(`ğŸ“¤ å‘é€æŸ¥è¯¢è¯·æ±‚: ${DAYUAPI_API_BASE}/v1/videos/${taskId}`, 'info');

                const response = await fetch(`${DAYUAPI_API_BASE}/v1/videos/${taskId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                    }
                });

                const responseText = await response.text();
                addLog(`ğŸ“¥ å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, 'info');
                addLog(`ğŸ“¥ å“åº”å†…å®¹: ${responseText.substring(0, 500)}`, response.ok ? 'success' : 'error');

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(`æ— æ³•è§£æå“åº” JSON: ${e.message}`);
                }

                if (!response.ok) {
                    throw new Error(data.error || data.message || 'æŸ¥è¯¢å¤±è´¥');
                }

                const progress = data.progress || 0;
                const status = data.status || 'unknown';

                let statusClass = 'pending';
                if (status === 'succeeded' || status === 'completed') statusClass = 'success';
                if (status === 'failed' || status === 'error') statusClass = 'error';

                resultDiv.innerHTML = `<div><span class="label">ä»»åŠ¡ ID:</span><span class="value">${data.id}</span></div>\n` +
                    `<div><span class="label">çŠ¶æ€:</span><span class="status-badge ${statusClass}">${status}</span></div>\n` +
                    `<div><span class="label">è¿›åº¦:</span><span class="value">${progress}%</span></div>\n` +
                    `<div><span class="label">æ¨¡å‹:</span><span class="value">${data.model || 'N/A'}</span></div>\n` +
                    (data.output?.[0]?.url ? `<div><span class="label">è§†é¢‘ URL:</span><a href="${data.output[0].url}" target="_blank" class="success">${data.output[0].url.substring(0, 60)}...</a></div>\n` : '') +
                    `\nå®Œæ•´å“åº”:\n${JSON.stringify(data, null, 2)}`;

                addLog(`âœ… æŸ¥è¯¢æˆåŠŸ: ${status}, è¿›åº¦ ${progress}%`, 'success');

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ é”™è¯¯: ${error.message}</div>`;
                addLog(`âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
            } finally {
                queryBtn.disabled = false;
                queryBtn.textContent = 'æµ‹è¯•æŸ¥è¯¢ä»»åŠ¡';
            }
        }

        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `<div class="${type}">[${timestamp}] ${message}</div>`;
            logsDiv.innerHTML = logLine + logsDiv.innerHTML;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            addLog('ğŸ—‘ï¸ æ—¥å¿—å·²æ¸…é™¤', 'info');
        }
    </script>
</body>
</html>
